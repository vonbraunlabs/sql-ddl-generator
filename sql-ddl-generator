#!/usr/bin/env php
<?php

foreach (array(__DIR__ . '/../../autoload.php', __DIR__ . '/../vendor/autoload.php', __DIR__ . '/vendor/autoload.php') as $file) {
    if (file_exists($file)) {
        define('AUTOLOAD_COMPOSER_INSTALL', $file);

        break;
    }
}

unset($file);

if (!defined('AUTOLOAD_COMPOSER_INSTALL')) {
    fwrite(
        STDERR,
        'You need to set up the project dependencies using Composer:' . PHP_EOL . PHP_EOL .
        '    composer install' . PHP_EOL . PHP_EOL .
        'You can learn all about Composer on https://getcomposer.org/.' . PHP_EOL
    );

    die(1);
}

function help(string $msg)
{
    fprintf(STDERR, "Error: %s" . PHP_EOL, $msg);
    fprintf(STDERR, "Usage: php sql-ddl-generator MODEL" . PHP_EOL . PHP_EOL);
    fprintf(STDERR, "    MODEL - a .json file or directory with a collection " .
        "of JSON files" . PHP_EOL);

    exit(1);
}

function processFolder(string $folder_name)
{
    $createSchema = true;
    foreach (glob($folder_name . '/' . '*.json') as $filename) {
        processSingleFile($filename, $createSchema);
        $createSchema = false;
    }
}

function processSingleFile(string $filename, $createSchema = true)
{
    $json = file_get_contents($filename);
    if (false === $json) {
        help('Could not read file ' . $file_name);
    }

    $model = json_decode($json, true);
    if (null === $model) {
        help("Could not interpret file #$filename# as a valid JSON");
    }

    echo "-- Generated by VBL - sql-ddl-generator" . PHP_EOL;
    $dm = new \VblSqlGen\MariaDB\Database($model, $createSchema);
    echo $dm . PHP_EOL;
}

if (count($argv) != 2) {
    help('Wrong number of arguments');
}


if (is_dir($argv[1])) {
    processFolder($argv[1]);
} elseif (is_file($argv[1])) {
    processSingleFile($argv[1]);
} else {
    echo $argv[1] . " is not a file or a folder" . PHP_EOL;
}
